# Shell Hook Architecture & Integrated Terminal Stability

**Last Updated:** 2025-12-10
**Context:** This document explains the specialized BASH shell hook architecture developed to resolve race conditions, terminal hangs, and missing timing metadata in integrated terminals (VS Code, WezTerm, etc.).

## Core Philosophy: "One Ring to Rule Them All"

The central design principle is that `bash-preexec` must be the **Single Source of Truth** for all shell hooks. We purposely disable disparate, ad-hoc `PROMPT_COMMAND` modifications in favor of a unified pipeline.

## The Architecture

### 1. Initialization Order (`bin/apply-hooks`)

1.  **Source `bash-preexec` FIRST**:
    *   This installs the foundational `precmd` (prompt display) and `preexec` (command execution) arrays.
    *   It takes over `PROMPT_COMMAND`.

2.  **Tool Initialization (Harvester Pattern)**:
    *   We run tool initializers (direnv, mcfly, starship, etc.) which typically try to append to `PROMPT_COMMAND`.
    *   **The Check**: We inspect `PROMPT_COMMAND` for these foreign hooks.
    *   **The Move**: We surgically remove them from `PROMPT_COMMAND` and append them to `precmd_functions` (for prompt hooks).
    *   **The Lock**: We declaratively reset `PROMPT_COMMAND` to contain *only* the `bash-preexec` triggers (`__bp_precmd_invoke_cmd` and `__bp_interactive_mode`).

### 2. Timing Strategy (`PS0` vs `DEBUG` Trap)

Historically, command timing (for Starship) relied on a `DEBUG` trap running before every command. This caused two major issues:
1.  **Complexity**: Starship's `preexec` logic required fragile state flags (`STARSHIP_PREEXEC_READY`).
2.  **Hangs**: In integrated terminals, `bash-preexec`'s DEBUG trap often blocked on `history` file access or TTY checks.

**The Solution: Native PS0**
We explicitly **DISABLE** `bash-preexec`'s DEBUG trap (`trap - DEBUG`) to prevent hangs.
Instead, we use Bash's native `PS0` (Prompt String 0) variable, which is printed by the shell *after* reading a command but *before* executing it.

```bash
# In apply-hooks:
starship_preexec_ps0() { command starship time; }
PS0='${STARSHIP_START_TIME:$((STARSHIP_START_TIME="$(starship_preexec_ps0)",0)):0}'
```
*   **Mechanism**: The `PS0` expansion runs the timing logic as a side-effect.
*   **Benefit**: Zero overhead, no traps, immune to history locks, 100% reliable start times.

### 3. Integrated Terminal Stability

Integrated terminals (VS Code, WezTerm) often present edge cases:
*   `stdout` might not be a TTY (`[ ! -t 1 ]`).
*   Concurrent history access causes locks.
*   They inject their own hooks (`__vsc_prompt_cmd`).

**Prevention Strategy:**
1.  **Harvest VS Code Hooks**: We verify that `__vsc_prompt_cmd` is preserved and moved to `precmd_functions` so terminal features (spinners, implementing `CWD` updates) still work.
2.  **Kill the Trap**: As mentioned, disabling the DEBUG trap was the key to eliminating hangs. Since we moved timing to `PS0` and don't strictly *need* pre-execution triggers for other tools (Direnv/Mcfly run at prompt time), this was a safe optimization.

## Summary of Components

| Component | Mechanism | Role |
| :--- | :--- | :--- |
| **bash-preexec** | `source` | The framework managing `precmd_functions`. |
| **Starship** | `PS0` + `precmd` | Timing capture (PS0) and Prompt rendering (precmd). |
| **Direnv** | `precmd_functions` | Environment loading (moved from PROMPT_COMMAND). |
| **Mcfly** | `bind -x` / `precmd` | History search (UI via keybind, hook via precmd). |
| **VS Code** | `precmd_functions` | Integration features (harvested from environment). |

## Debugging

If issues recur:
1.  **Check Hooks**: `declare -p precmd_functions` (Should be a clean list of function names).
2.  **Check Prompt Command**: `declare -p PROMPT_COMMAND` (Should ONLY contain `__bp_...` functions).
3.  **Check Traps**: `trap -p DEBUG` (Should be EMPTY).
4.  **Verify Timing**: `echo $PS0` (Should contain the Starship magic string).

---
*Generated by Antigravity Agent*
