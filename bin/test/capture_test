#!/usr/bin/env bash

# Test for the capture script

# Set the dotfiles directory and add bin to the PATH
if [[ -z "$DOTFILES_DIR" ]]; then
	DOTFILES_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
fi
export PATH="$DOTFILES_DIR/bin:$PATH"

# Source the library file under test
source "$DOTFILES_DIR/bin/src/capture.bash"

# Ensure assert is available
if ! command -v assert &> /dev/null; then
	echo "assert command not found. It should be in '$DOTFILES_DIR/bin'." >&2
	exit 1
fi

# Initialize counters
tests=0
fails=0

# Helper function to run a single test case
run_test_case() {
    local test_name="$1"
    local test_func_name="$2"
    
    ((tests++))
    echo "Running Test $tests: $test_name"

    # Call the test function
    if "$test_func_name"; then
        echo "✅ Test $tests: $test_name PASSED"
    else
        echo "❌ Test $tests: $test_name FAILED" >&2
        ((fails++))
    fi
}

# --- Test Functions ---

test_1_simple_command() {
    local out err rc
    local test_fail=0
    capture echo "hello world"
    assert "$out" "==" "hello world" "Test 1.1: out was '$out'" || test_fail=1
    assert "$err" "==" "" "Test 1.2: err was '$err'" || test_fail=1
    if [[ "$rc" -eq 0 ]]; then
        : # pass
    else
        echo "Assertion failed: Test 1.3: rc was '$rc', expected 0" >&2
        test_fail=1
    fi
    return "$test_fail"
}

test_2_stdout_stderr() {
    local out err rc
    local test_fail=0
    capture bash -c 'echo "to stdout"; echo "to stderr" >&2'
    assert "$out" "==" "to stdout" "Test 2.1: out was '$out'" || test_fail=1
    assert "$err" "==" "to stderr" "Test 2.2: err was '$err'" || test_fail=1
    if [[ "$rc" -eq 0 ]]; then
        : # pass
    else
        echo "Assertion failed: Test 2.3: rc was '$rc', expected 0" >&2
        test_fail=1
    fi
    return "$test_fail"
}

test_3_non_zero_exit_code() {
    local out err rc
    local test_fail=0
    capture bash -c 'echo "error msg" >&2; exit 42'
    assert "$out" "==" "" "Test 3.1: out was '$out'" || test_fail=1
    assert "$err" "==" "error msg" "Test 3.2: err was '$err'" || test_fail=1
    if [[ "$rc" -eq 42 ]]; then
        : # pass
    else
        echo "Assertion failed: Test 3.3: rc was '$rc', expected 42" >&2
        test_fail=1
    fi
    return "$test_fail"
}

test_4_null_byte_no_p() {
    local out err rc
    local test_fail=0
    capture printf 'a\0b' 2>/dev/null
    assert "$out" "==" "ab" "Test 4.1: out was '$out' (Bash vars drop NULs)" || test_fail=1
    assert "$err" "==" "" "Test 4.2: err was '$err'" || test_fail=1
    if [[ "$rc" -eq 0 ]]; then
        : # pass
    else
        echo "Assertion failed: Test 4.3: rc was '$rc', expected 0" >&2
        test_fail=1
    fi
    return "$test_fail"
}

test_5_null_byte_with_p() {
    local out err rc
    local test_fail=0
    local processed_nul
    processed_nul=$(printf '\0' | printable_binary)

    capture -p printf "a\0b"
    assert "$out" "==" "a${processed_nul}b" "Test 5.1: out was '$out'" || test_fail=1
    assert "$err" "==" "" "Test 5.2: err was '$err'" || test_fail=1
    if [[ "$rc" -eq 0 ]]; then
        : # pass
    else
        echo "Assertion failed: Test 5.3: rc was '$rc', expected 0" >&2
        test_fail=1
    fi
    return "$test_fail"
}

test_6_command_flags() {
    local out err rc
    local test_fail=0
    capture grep -o "found" <<< "something found here"
    assert "$out" "==" "found" "Test 6.1: out was '$out'" || test_fail=1
    assert "$err" "==" "" "Test 6.2: err was '$err'" || test_fail=1
    if [[ "$rc" -eq 0 ]]; then
        : # pass
    else
        echo "Assertion failed: Test 6.3: rc was '$rc', expected 0" >&2
        test_fail=1
    fi
    return "$test_fail"
}

test_7_separator() {
    local out err rc
    local test_fail=0
    
    local temp_dir
    temp_dir=$(mktemp --tmpdir -d capture_test.XXXXXX)
    trap 'rm -rf "$temp_dir"' RETURN

    cat > "$temp_dir/-p" <<'EOF'
#!/usr/bin/env bash
echo "this is the -p script"
EOF
    chmod +x "$temp_dir/-p"

    local old_path="$PATH"
    export PATH="$temp_dir:$PATH"

    capture -- -p
    assert "$out" "==" "this is the -p script" "Test 7.1: out was '$out'" || test_fail=1
    
    export PATH="$old_path"
    return "$test_fail"
}

test_8_required_vars_not_declared() {
    local err exit_code
    local test_fail=0
    
    # Run in a subshell where 'out' is explicitly not declared to trigger capture's check
    (
        unset out # Ensure 'out' is not present in the subshell environment
        capture echo "test"
    ) &> /dev/null
    exit_code=$?
    if [[ "$exit_code" -ne 0 ]]; then
        : # pass
    else
        echo "Assertion failed: Test 8.1: capture should fail, but exit code was $exit_code" >&2
        test_fail=1
    fi

    # Check the error message from capture (it prints to stderr)
    err=$( (unset out; capture echo "foo" ) 2>&1 )
    assert "$err" "=~" "required variable \"out\" is not declared" "Test 8.2: err was '$err'" || test_fail=1
    return "$test_fail"
}

test_9_no_command_given() {
    local err rc
    local test_fail=0
    
    # This call will cause capture to print to stderr and return 2
    capture &>/dev/null 
    local exit_code=$?
    if [[ "$exit_code" -eq 2 ]]; then
        : # pass
    else
        echo "Assertion failed: Test 9.1: exit code was $exit_code, expected 2" >&2
        test_fail=1
    fi
    
    # Capture stderr for message check
    err=$(capture 2>&1) 
    assert "$err" "==" "capture: no command given" "Test 9.2: err was '$err'" || test_fail=1
    return "$test_fail"
}


# --- Main Test Execution ---
echo "Testing capture..."

run_test_case "Simple command (echo)" test_1_simple_command
run_test_case "Command with stdout and stderr" test_2_stdout_stderr
run_test_case "Command with non-zero exit code" test_3_non_zero_exit_code
run_test_case "Command with NULL byte, without -p flag" test_4_null_byte_no_p
run_test_case "Command with NULL byte, with -p flag" test_5_null_byte_with_p
run_test_case "Command with arguments starting with -" test_6_command_flags
run_test_case "-- separator" test_7_separator
run_test_case "Required variables not declared (should fail)" test_8_required_vars_not_declared
run_test_case "No command given" test_9_no_command_given

# --- Summary ---
echo
if (( fails == 0 )); then
	echo "✅ All $tests tests passed."
else
	echo "❌ $fails of $tests tests failed." >&2
	exit "$fails"
fi
