#!/usr/bin/env bash

test_show_wat_detection() {
	local fails=0
	local tests=0

	echo "Testing show language detection for wasmrun scripts..."

	((tests++))
	echo "Testing determine_language_from_source returns wat for wasmrun shebang..."
	local output exit_code=0
	output=$(PATH="$HOME/bin:$PATH" bash -lc 'source "$HOME/dotfiles/bin/src/show.sh"; determine_language_from_source "$HOME/dotfiles/bin/ns"' 2>/tmp/show_wat_stderr.$$)
	exit_code=$?

	if [ $exit_code -eq 0 ] && [ "$output" = "wat" ]; then
		echo "[PASS] wasmrun shebang classified as wat"
	else
		echo "[FAIL] wasmrun detection output: exit=$exit_code, value='${output}'" >&2
		echo "--- stderr ---" >&2
		cat /tmp/show_wat_stderr.$$ >&2
		echo "--------------" >&2
		((fails++))
	fi

	rm -f /tmp/show_wat_stderr.$$

	((tests++))
	echo "Testing show uses lisp highlighting for wat files via bat..."
	local tmp_dir
	tmp_dir=$(mktemp -d)
	local bat_log="$tmp_dir/bat_args"
	cat >"$tmp_dir/bat" <<EOF
#!/usr/bin/env bash
echo "\$@" >"$bat_log"
cat "\${@: -1}"
EOF
	chmod +x "$tmp_dir/bat"

	local show_stderr="$tmp_dir/show_wat_stderr"
	if PATH="$tmp_dir:$HOME/bin:$PATH" bash -lc 'source "$HOME/dotfiles/bin/src/show.sh"; show "$HOME/dotfiles/bin/ns"' >"$tmp_dir/show_output" 2>"$show_stderr"; then
		if grep -q "\-l lisp" "$bat_log"; then
			echo "[PASS] show invoked bat with lisp highlighting for wat file"
		else
			echo "[FAIL] bat invocation missing lisp highlight flag" >&2
			cat "$bat_log" >&2
			((fails++))
		fi
	else
		echo "[FAIL] show command failed when displaying wat file" >&2
		cat "$show_stderr" >&2
		((fails++))
	fi

	rm -rf "$tmp_dir"

	if [ $fails -gt 0 ]; then
		echo "show_wat_test FAILED: $fails of $tests tests failed" >&2
	else
		echo "show_wat_test PASSED: all $tests tests passed"
	fi
	return $fails
}

if ! (return 0 2>/dev/null); then
	test_show_wat_detection
	exit $?
fi
