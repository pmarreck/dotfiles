#!/usr/bin/env bash

# Test for find_github_forks_with_file
# Exit code should be number of failed tests

fails=0
tests=0

tmp_dir=$(mktemp -d --tmpdir)
if [[ ! -d "$tmp_dir" ]]; then
	echo "FAIL: Failed to create temp directory" >&2
	exit 1
fi

real_xargs=$(command -v xargs)
if [[ -z "$real_xargs" ]]; then
	echo "FAIL: Failed to locate xargs" >&2
	exit 1
fi

cleanup() {
	rm -rf "$tmp_dir"
}
trap cleanup EXIT

# Create a stub gh command
cat <<'GH_EOF' > "$tmp_dir/gh"
#!/usr/bin/env bash

if [[ "$1" != "api" ]]; then
	echo "Unexpected args: $*" >&2
	exit 2
fi

endpoint="$2"
case "$endpoint" in
	repos/owner/repo/forks)
		printf '%s\n' "alice/openmpt" "bob/openmpt"
		exit 0
		;;
	repos/alice/openmpt/contents/build.zig)
		echo '{"type":"file"}'
		exit 0
		;;
	repos/bob/openmpt/contents/build.zig)
		echo "Not Found (HTTP 404)" >&2
		exit 1
		;;
	repos/alice/openmpt)
		echo "main"
		exit 0
		;;
	repos/bob/openmpt)
		echo "master"
		exit 0
		;;
	*)
		echo "Unexpected endpoint: $endpoint" >&2
		exit 2
		;;
esac
GH_EOF
chmod +x "$tmp_dir/gh"

# Create a stub xargs command to detect conflicting flags
cat <<EOF > "$tmp_dir/xargs"
#!/usr/bin/env bash

real_xargs="$real_xargs"

has_replace=false
has_max_args=false
has_max_chars=false

for arg in "\$@"; do
	case "\$arg" in
		-I|-i|--replace|-I*|--replace=*)
			has_replace=true
			;;
		-n|--max-args|-n*|--max-args=*)
			has_max_args=true
			;;
		-s|--max-chars|-s*|--max-chars=*)
			has_max_chars=true
			;;
	esac
done

if \$has_replace && \$has_max_args; then
	echo "xargs: warning: options --max-args and --replace/-I/-i are mutually exclusive, ignoring previous --max-args value" >&2
fi

if \$has_max_chars; then
	echo "xargs: value 1048576 for -s option should be <= 1009993" >&2
fi

exec "\$real_xargs" "\$@"
EOF
chmod +x "$tmp_dir/xargs"

# Test 1: No xargs warnings and expected output
((tests++))
echo "Testing: find_github_forks_with_file runs without xargs warnings..."
stdout_file=$(mktemp --tmpdir)
stderr_file=$(mktemp --tmpdir)

PATH="$tmp_dir:$PATH" find_github_forks_with_file --file build.zig owner/repo >"$stdout_file" 2>"$stderr_file"
exit_code=$?

if [[ $exit_code -eq 0 ]] && ! grep -q "xargs:" "$stderr_file"; then
	if grep -q "Found build.zig in 1 out of 2 forks:" "$stdout_file" && \
		grep -q "alice/openmpt" "$stdout_file" && \
		grep -q "https://github.com/alice/openmpt/blob/main/build.zig" "$stdout_file" && \
		! grep -q "bob/openmpt" "$stdout_file"; then
		echo "OK: No xargs warnings and expected results"
	else
		echo "FAIL: Output did not match expectations" >&2
		echo "--- stdout ---" >&2
		cat "$stdout_file" >&2
		echo "--- stderr ---" >&2
		cat "$stderr_file" >&2
		((fails++))
	fi
else
	echo "FAIL: Command failed or xargs warnings detected" >&2
	echo "Exit code: $exit_code" >&2
	echo "--- stdout ---" >&2
	cat "$stdout_file" >&2
	echo "--- stderr ---" >&2
	cat "$stderr_file" >&2
	((fails++))
fi

rm -f "$stdout_file" "$stderr_file"

echo

if [[ $fails -eq 0 ]]; then
	echo "All $tests tests passed"
else
	echo "$fails of $tests tests failed" >&2
fi

exit $fails
