#!/usr/bin/env bash

# rm override shim: routes to rm-safe when available; falls back to system rm

SAFE_RM=$(command -v rm-safe 2>/dev/null || true)
REAL_RM=${REAL_RM:-/bin/rm}
SELF_PATH=${BASH_SOURCE[0]:-$0}

# Avoid recursion: if rm-safe or REAL_RM point to this shim, ignore them
if [[ -n "$SAFE_RM" ]] && [[ "$SAFE_RM" == "$SELF_PATH" || "$SAFE_RM" == "$REAL_RM" ]]; then
	echo "rm override: detected recursive SAFE_RM; ignoring" >&2
	SAFE_RM=""
fi

if [[ -n "$REAL_RM" ]] && [[ "$REAL_RM" == "$SELF_PATH" ]]; then
	echo "rm override: detected recursive REAL_RM; falling back to system rm" >&2
	REAL_RM=""
fi

if [[ -x "$SAFE_RM" ]]; then
	exec "$SAFE_RM" "$@"
fi

# Warn once per invocation when rm-safe is missing
echo "rm override: rm-safe not found in PATH; using system rm" >&2

# Prefer provided REAL_RM, else fallback to known locations, else command -p rm
if [[ -n "$REAL_RM" && -x "$REAL_RM" ]]; then
	exec "$REAL_RM" "$@"
elif [[ -x /usr/bin/rm ]]; then
	exec /usr/bin/rm "$@"
elif [[ -x /bin/rm ]]; then
	exec /bin/rm "$@"
else
	exec command -p rm "$@"
fi
