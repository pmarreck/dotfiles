#!/usr/bin/env yuerun

-- Load quotes from data file
load_quotes = ->
  quotes_file = "#{os.getenv('HOME')}/dotfiles/bin/data/warhammer_quotes.txt"
  quotes = {}
  
  -- Open and read the file
  file = io.open(quotes_file, "r")
  unless file
    error("Could not open quotes file: #{quotes_file}")
  
  for line in file\lines!
    -- Skip empty lines
    if line\match("^%s*$") == nil
      table.insert(quotes, line)
  
  file\close!
  quotes

-- Get better random seed from /dev/urandom
get_random_seed = ->
  urandom = io.open("/dev/urandom", "rb")
  if urandom
    bytes = urandom\read(4)
    urandom\close!
    seed = 0
    for i = 1, #bytes
      seed = seed * 256 + string.byte(bytes, i)
    seed
  else
    -- Fallback to time-based seed with microseconds
    os.time! + os.clock! * 1000000

-- Seed random number generator with better randomness
math.randomseed(get_random_seed!)

-- Main function
warhammer_quote = ->
  quotes = load_quotes!
  
  -- Select random quote and add exclamation
  random_index = math.random(1, #quotes)
  selected_quote = quotes[random_index]
  
  print("#{selected_quote}!")

-- Handle command line execution
if not pcall(debug.getlocal, 4, 1)
  -- Check for --test flag
  if arg and arg[1] == "--test"
    -- Execute the test file, silence stdout but show stderr
    test_file = "#{os.getenv('HOME')}/dotfiles/bin/test/warhammer_quote_test"
    os.execute("#{test_file} >/dev/null")
  else
    -- Run the main function
    warhammer_quote!