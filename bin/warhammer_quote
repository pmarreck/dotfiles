#!/usr/bin/env yuerun

-- Load quotes from data file
load_quotes = ->
	quotes_file = "#{os.getenv('HOME')}/dotfiles/bin/data/warhammer_quotes.txt"
	quotes = {}

	-- Open and read the file
	file = io.open(quotes_file, "r")
	unless file
		error("Could not open quotes file: #{quotes_file}")

	for line in file\lines!
		-- Skip empty lines
		if line\match("^%s*$") == nil
			table.insert(quotes, line)

	file\close!
	quotes

-- Main function
warhammer_quote = ->
	quotes = load_quotes!

	-- Use our high-quality random utility to select quote
	random_index = tonumber(io.popen("random 1 #{#quotes}")\read("*a")\match("%d+"))
	selected_quote = quotes[random_index]

	print("#{selected_quote}!")

-- Handle command line execution
if not pcall(debug.getlocal, 4, 1)
	-- Check for --test flag
	if arg and arg[1] == "--test"
		-- Execute the test file, silence stdout but show stderr
		test_file = "#{os.getenv('HOME')}/dotfiles/bin/test/warhammer_quote_test"
		os.execute("#{test_file} >/dev/null")
	else
		-- Run the main function
		warhammer_quote!
