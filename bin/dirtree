#!/usr/bin/env bash

# dirtree: A simple wrapper around eza for directory trees

show_help() {
  echo "dirtree - Display directory trees using eza"
  echo ""
  echo "Usage: dirtree [OPTIONS] [PATH]"
  echo ""
  echo "Options:"
  echo "  -h, --help     Show this help message"
  echo "  -a, --about    Show detailed description"
  echo "  -d, --depth N  Set maximum depth (default: 2)"
  echo "  --test         Run associated tests"
  echo ""
  echo "Examples:"
  echo "  dirtree              # Show tree of current directory"
  echo "  dirtree /path/to/dir # Show tree of specified directory"
  echo "  dirtree -d 3         # Set depth to 3 levels"
}

# Default values
depth=2
dir="."

# Parse command line arguments
while [[ $# -gt 0 ]]; do
  case "$1" in
    -h|--help)
      show_help
      exit 0
      ;;
    -a|--about)
      echo "dirtree outputs a nice directory tree using eza with icons, git status, and hyperlinks."
      exit 0
      ;;
    -d|--depth)
      shift
      if [[ -n "$1" && "$1" =~ ^[0-9]+$ ]]; then
        depth="$1"
      else
        echo "Error: --depth requires a numeric argument" >&2
        exit 1
      fi
      ;;
    --test)
      if [[ -x "$(dirname "$0")/test/dirtree_test" ]]; then
        "$(dirname "$0")/test/dirtree_test" >/dev/null
      else
        echo "Error: dirtree_test not found or not executable." >&2
        exit 1
      fi
      exit $?
      ;;
    -*)
      echo "Unknown option: $1" >&2
      exit 1
      ;;
    *)
      # This is the directory argument
      dir="$1"
      break
      ;;
  esac
  shift
done

# Check if eza is available
if ! command -v eza >/dev/null 2>&1; then
  echo "Error: eza is not installed. Please install eza first." >&2
  exit 1
fi

# Validate directory exists
if [[ ! -d "$dir" ]]; then
  echo "Error: '$dir' is not a directory" >&2
  exit 1
fi

# Run eza with the specified options
eza --tree --hyperlink --icons --git --sort modified --reverse --level "$depth" --all "$dir"