#!/usr/bin/env bash

drandom() {
	[ -n "${EDIT}" ] && unset EDIT && edit_function "${FUNCNAME[0]}" "$BASH_SOURCE" && return

	local start=${1:-0}
	local end=${2:-99}

	# Define BASH_INT_MAX if not already defined (for when run as script)
	if [ -z "$BASH_INT_MAX" ]; then
		local BASH_INT_MAX=$((2**31 - 1))
	fi

	# Initialize DRANDOM_SEED if not set
	if [ -z "$DRANDOM_SEED" ]; then
		# Use nanoseconds from date if available, otherwise use RANDOM
		if command -v date >/dev/null 2>&1 && date +%N >/dev/null 2>&1; then
			DRANDOM_SEED=$(($(date +%s%N) % BASH_INT_MAX))
		else
			DRANDOM_SEED=$((RANDOM * 65536 + RANDOM))
		fi
	fi

	# LCG parameters (same as Numerical Recipes)
	# These work well within bash's integer range
	local a=1664525
	local c=1013904223

	# Update seed using LCG formula
	# We need to handle potential overflow carefully
	DRANDOM_SEED=$(( (a * DRANDOM_SEED + c) & 0x7FFFFFFF ))

	# Calculate range
	local range=$((end - start + 1))

	# Generate result in the requested range
	if [ $range -le 1 ]; then
		echo $start
	else
		# Use modulo to get value in range
		# For better distribution, we could implement rejection sampling
		# but for most use cases, simple modulo is sufficient
		echo $((start + (DRANDOM_SEED % range)))
	fi
}

# Run the function if this script is executed directly
if ! (return 0 2>/dev/null); then
	# Check if we are running tests
	if [ "$1" = "--test" ]; then
		# Run tests from the test file with stdout muted
		test_file="$HOME/dotfiles/bin/test/$(basename "${0##\-}")_test"
		if [ -f "$test_file" ]; then
			exec "$test_file" >/dev/null
		else
			echo "Test file not found: $test_file" >&2
			exit 1
		fi
	elif [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
		cat <<-EOF
		Usage: drandom [start] [end]
		       DRANDOM_SEED=<seed> drandom [start] [end]

		Deterministic random number generator using Linear Congruential Generator.
		Outputs a random integer between start and end (inclusive).

		If start is not specified, it defaults to 0
		If end is not specified, it defaults to 99

		Set DRANDOM_SEED environment variable for reproducible sequences.
		The seed is automatically updated after each call, so setting it once
		at the beginning of a sequence will produce deterministic results.

		Examples:
		  drandom           # Random number from 0-99
		  drandom 1 6       # Roll a die (1-6)
		  drandom 0 1       # Coin flip (0 or 1)

		  # Deterministic sequence:
		  DRANDOM_SEED=12345
		  drandom           # First number (deterministic)
		  drandom           # Second number (deterministic)
		EOF
	else
		# Source ourselves to get the function
		source "$0"
		# If called directly with no arguments, show the range note
		if [ $# -eq 0 ]; then
			echo "(with a start of 0 and an end of 99)" >&2
		fi
		# Pass all arguments to the function
		drandom "$@"
	fi
fi
